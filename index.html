<script>
  const RAW_URL = "https://gist.githubusercontent.com/marcos1982x/2256f9985eb31b67d91bc353948f49bc/raw/gistfile1.txt";

  const el = document.getElementById("subtitle");

  let currentText = "";   // 已經顯示在畫面上的字幕
  let pendingText = "";   // 候選的新字幕
  let pendingCount = 0;   // 連續抓到候選字幕的次數
  const STABLE_TIMES = 3; // 需要連續幾次一樣才更新（3 次 ≈ 6 秒）

  async function updateSubtitle() {
    try {
      const res = await fetch(RAW_URL + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) return;

      const text = (await res.text()).trim();
      if (!text) return;

      // 和現在畫面一樣 → 代表沒變，清掉候選狀態
      if (text === currentText) {
        pendingText = "";
        pendingCount = 0;
        return;
      }

      // 和候選字幕一樣 → 次數 +1
      if (text === pendingText) {
        pendingCount++;
      } else {
        // 第一次看到不同的內容 → 設成候選，計數從 1 開始
        pendingText = text;
        pendingCount = 1;
      }

      // 連續 STABLE_TIMES 次都拿到同一份新字幕 → 才真正更新畫面
      if (pendingCount >= STABLE_TIMES) {
        currentText = pendingText;
        el.innerHTML = currentText.replace(/\n/g, "<br>");

        // 小小晃動一下 opacity，逼 Prism 重畫
        el.style.opacity = "0.99";
        setTimeout(() => { el.style.opacity = "1"; }, 50);

        // 重置候選狀態
        pendingText = "";
        pendingCount = 0;
      }
    } catch (e) {
      console.log(e);
    }
  }

  // 先抓一次，之後每 2 秒檢查一次
  updateSubtitle();
  setInterval(updateSubtitle, 2000);
</script>
